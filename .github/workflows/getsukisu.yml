name: Get KernelSU Manager

on:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      kernelsu_variant:
        type: choice
        description: "é€‰æ‹© KernelSU å˜ä½“"
        required: true
        default: "Next"
        options:
          - "Next"
          - "SukiSU"

permissions:
  contents: write
  actions: read

jobs:
  get_ksu_manager:
    runs-on: ubuntu-latest
    env:
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: å®‰è£…ä¾èµ–
        run: sudo apt update && sudo apt install -y git curl jq

      - name: è®¾å®š KSU ç¯å¢ƒå˜é‡
        run: |
          if [ "${{ github.event.inputs.kernelsu_variant || 'Next' }}" == "Next" ]; then
            echo "This is the Next variant"
            git clone https://github.com/KernelSU-Next/KernelSU-Next.git
            cd KernelSU-Next
            KSU_GIT_VERSION=$(git rev-list --count HEAD)
            KSU_VERSION=$((10000 + KSU_GIT_VERSION + 200))
            echo "KSU_VERSION=$KSU_VERSION" >> $GITHUB_ENV
            echo "REPO=KernelSU-Next/KernelSU-Next" >> $GITHUB_ENV
            echo "FILENAME=build-manager-ci.yml" >> $GITHUB_ENV
          elif [ "${{ github.event.inputs.kernelsu_variant || 'Next' }}" == "SukiSU" ]; then
            echo "This is the SukiSU variant"
            git clone https://github.com/SukiSU-Ultra/SukiSU-Ultra.git
            cd SukiSU-Ultra
            KSU_GIT_VERSION=$(git rev-list --count HEAD)
            KSU_VERSION=$((10000 + KSU_GIT_VERSION + 700))
            echo "KSU_VERSION=$KSU_VERSION" >> $GITHUB_ENV
            echo "REPO=SukiSU-Ultra/SukiSU-Ultra" >> $GITHUB_ENV
            echo "FILENAME=build-manager.yml" >> $GITHUB_ENV
          else
            echo "Unknown variant"
            exit 1
          fi

      - name: è·å–æœ€æ–°æ„å»ºçš„ Manager
        run: |
          # è·å–æœ€æ–°æˆåŠŸæ„å»ºçš„ ID
          BUILD_ID=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/$REPO/actions/workflows/$FILENAME/runs?status=success&per_page=1" | \
          jq -r '.workflow_runs[0].id')
          echo "BUILD_ID=$BUILD_ID"
          
          # è·å–è¯¥æ„å»ºçš„ Artifacts
          ARTIFACTS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/$REPO/actions/runs/$BUILD_ID/artifacts")
          echo "ARTIFACTS_COUNT=$(echo "$ARTIFACTS" | jq -r '.artifacts | length')"
          
          # è·å– Manager æ–‡ä»¶çš„ä¸‹è½½é“¾æ¥
          DOWNLOAD_URL=$(echo "$ARTIFACTS" | jq -r '.artifacts[] | select(.name | contains("Manager")) | .archive_download_url')
          echo "DOWNLOAD_URL=$DOWNLOAD_URL"
          
          if [ -z "$DOWNLOAD_URL" ] || [ "$DOWNLOAD_URL" == "null" ]; then
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ° Manager æ–‡ä»¶"
            exit 1
          fi

          # ä¸‹è½½ Manager æ–‡ä»¶
          curl -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -o "manager.zip" "$DOWNLOAD_URL"
          echo "Manager æ–‡ä»¶ä¸‹è½½å®Œæˆ"
          
          # è§£å‹æ–‡ä»¶
          unzip -o manager.zip -d manager_files/
          echo "æ–‡ä»¶è§£å‹å®Œæˆ"
          
          # æŸ¥æ‰¾ APK æ–‡ä»¶
          find manager_files/ -name "*.apk" -exec cp {} ./ \;
          APK_FILE=$(find . -maxdepth 1 -name "*.apk" | head -1)
          echo "APK_FILE=$APK_FILE" >> $GITHUB_ENV

      - name: æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
        run: |
          echo "æ‰¾åˆ°çš„ APK æ–‡ä»¶ï¼š"
          ls -la *.apk || echo "æœªæ‰¾åˆ° APK æ–‡ä»¶"
          echo "Manager ç‰ˆæœ¬ï¼š$KSU_VERSION"

      - name: ä¸Šä¼ ç¼–è¯‘èµ„äº§
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.kernelsu_variant || 'Next' }}-Manager-${{ env.KSU_VERSION }}
          path: "*.apk"
          retention-days: 30

      - name: æ˜¾ç¤ºå®Œæˆä¿¡æ¯
        run: |
          echo "========================================"
          echo "âœ… KernelSU Manager è·å–å®Œæˆï¼"
          echo "ğŸ”§ å˜ä½“: ${{ github.event.inputs.kernelsu_variant || 'Next' }}"
          echo "ğŸ“± ç‰ˆæœ¬: ${{ env.KSU_VERSION }}"
          echo "ğŸ“¦ æ–‡ä»¶: ${{ env.APK_FILE }}"
          echo "========================================"
